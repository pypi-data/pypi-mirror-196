import argparse
import sys
from github import Github
import os


def print_pulls(repo_name, title, pulls):
    if len(pulls)  > 0:
        print("**{}:**".format(title))
        print()
        for (pull, commit) in pulls:
            url = "https://github.com/{}/pull/{}".format(repo_name, pull.number)
            print("- {} [#{}]({}) ({})".format(pull.title, pull.number, url, commit.author.login))
        print()


def generate_changelog(repo, repo_name, commit_shas):

    #TODO: show progress
    commits = [repo.get_commit(sha) for sha in commit_shas]

    all_pulls = []

    # we split the pulls into categories
    #TODO: make categories configurable
    breaking = []
    bugs = []
    docs = []
    enhancements = []

    #TODO: show progress
    for commit in commits:
        pulls = commit.get_pulls()
        for pull in pulls:
            all_pulls.append((pull, commit))

    # categorize the pull requests based on GitHub labels
    for (pull, commit) in all_pulls:
        labels = [label.name for label in pull.labels]
        if 'api change' in labels:
            breaking.append((pull, commit))
        elif 'bug' in labels:
            bugs.append((pull, commit))
        elif 'enhancement' in labels:
            enhancements.append((pull, commit))
        elif 'documentation' in labels:
            docs.append((pull, commit))

    # produce the changelog content
    print_pulls(repo_name, "Breaking changes", breaking)
    print_pulls(repo_name, "Implemented enhancements", enhancements)
    print_pulls(repo_name, "Fixed bugs", bugs)
    print_pulls(repo_name, "Documentation updates", docs)
    print_pulls(repo_name, "Merged pull requests", all_pulls)


def cli(args=None):
    """Process command line arguments."""
    if not args:
        args = sys.argv[1:]

    parser = argparse.ArgumentParser()
    parser.add_argument("project", help="The project name e.g. apache/arrow-datafusion")
    parser.add_argument("commits", help="The filename containing Git hashes generated by a git log command")
    args = parser.parse_args()

    token = os.getenv("GITHUB_TOKEN")

    g = Github(token)
    repo = g.get_repo(args.project)
    with open(args.commits, "r") as f:
        commit_shas = f.readlines()
        generate_changelog(repo, args.project, commit_shas)

if __name__ == "__main__":
    cli()